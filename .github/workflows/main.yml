name: Parse SVGs from Issue (zip)

on:
  issues:
    types: [opened]

jobs:
  parse:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Extract first attachment URL
        id: extract
        run: |
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "${{ github.event.issue.body }}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Download first zip
        run: |
          mkdir -p input_zip
          url=$(echo "${{ github.event.issue.body }}" \
            | grep -o 'https://github.com/user-attachments/files/[0-9]*/[^)]*' \
            | head -n1)
          if [ -z "$url" ]; then
            echo "âŒ No zip attachment found in issue body"
            exit 1
          fi
          echo "Downloading first attachment: $url"
          curl -L "$url" -o input_zip/files.zip

      - name: Unzip SVGs
        run: |
          mkdir -p svgs
          unzip -jo input_zip/files.zip -d svgs

      - name: Process SVGs
        run: |
          mkdir -p parsed_svgs
          python main.py svgs/*.svg parsed_svgs

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: parsed-svgs
          path: parsed_svgs/

      - name: Comment with artifact link and summary
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.issue.number;
            const artifact_url = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const summaryRaw = process.env.summary;
      
            if (!summaryRaw) {
              throw new Error("summary is undefined. Check previous step output.");
            }
      
            const summary = JSON.parse(summaryRaw);
      
            let successList = summary.success.length
              ? summary.success.map(f => `- ${f}`).join("\n")
              : "ãªã—";
      
            let failList = summary.fail.length
              ? summary.fail.map(f => `- ${f.file}: ${f.error}`).join("\n")
              : "ãªã—";
      
            const body = [
              "âœ… SVGã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼",
              "",
              "### æˆåŠŸãƒ•ã‚¡ã‚¤ãƒ«",
              successList,
              "",
              "### å¤±æ•—ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã‚¨ãƒ©ãƒ¼å†…å®¹ä»˜ãï¼‰",
              failList,
              "",
              `ğŸ“¦ çµæœã¯ã“ã¡ã‚‰ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™: [Artifacts](${artifact_url})`
            ].join("\n");
      
            github.rest.issues.createComment({
              issue_number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
